<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

  <Product
    Id="*"
    Name="Network Observability Agent"
    Language="1033"
    Version="2.0.0"
    Manufacturer="Enterprise IT"
    UpgradeCode="{A1B2C3D4-E5F6-47A1-9ABC-123456789000}">

    <Package
      InstallerVersion="500"
      Compressed="yes"
      InstallScope="perMachine" />

    <!-- Major upgrade support -->
    <MajorUpgrade
      Schedule="afterInstallInitialize"
      DowngradeErrorMessage="A newer version of Network Observability Agent is already installed." />

    <MediaTemplate />

    <!-- ===================== -->
    <!-- DIRECTORY STRUCTURE -->
    <!-- ===================== -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLDIR" Name="NetworkObservabilityAgent" />
      </Directory>
    </Directory>

    <!-- ===================== -->
    <!-- COMPONENTS -->
    <!-- ===================== -->

    <!-- AGENT + SERVICE -->
    <Component
      Id="AgentExeComponent"
      Guid="{94684669-D88B-5951-8C8F-B35855504F17}"
      Directory="INSTALLDIR">

      <File
        Id="AgentExe"
        Source="payload\agent.exe"
        KeyPath="yes" />

      <!-- WINDOWS SERVICE (MSI-NATIVE) -->
      <ServiceInstall
        Id="NetworkAgentService"
        Name="NetworkObservabilityAgent"
        DisplayName="Network Observability Agent"
        Description="Dynatrace Network Observability Agent"
        Type="ownProcess"
        Start="auto"
        ErrorControl="normal"
        Vital="yes"
        Account="LocalSystem"
        Arguments="--service" />

      <ServiceControl
        Id="NetworkAgentServiceControl"
        Name="NetworkObservabilityAgent"
        Start="install"
        Stop="both"
        Remove="uninstall"
        Wait="yes" />

    </Component>

    <!-- INSTALL SCRIPT -->
    <Component
      Id="InstallScriptComponent"
      Guid="{E91553C7-16DC-5013-8FAD-3B7E60363F0E}"
      Directory="INSTALLDIR">

      <File
        Id="InstallScript"
        Source="payload\install.ps1"
        KeyPath="yes" />
    </Component>

    <!-- UNINSTALL SCRIPT -->
    <Component
      Id="UninstallScriptComponent"
      Guid="{8CE21AEA-8417-552D-B9F7-7EFC73C75A13}"
      Directory="INSTALLDIR">

      <File
        Id="UninstallScript"
        Source="payload\uninstall.ps1"
        KeyPath="yes" />
    </Component>

    <!-- ===================== -->
    <!-- FEATURES -->
    <!-- ===================== -->
    <Feature
      Id="MainFeature"
      Title="Network Observability Agent"
      Level="1">

      <ComponentRef Id="AgentExeComponent" />
      <ComponentRef Id="InstallScriptComponent" />
      <ComponentRef Id="UninstallScriptComponent" />

    </Feature>

    <!-- ===================== -->
    <!-- CUSTOM ACTIONS -->
    <!-- ===================== -->

    <!-- Optional post-install script (NO SERVICE CREATION HERE) -->
    <CustomAction
      Id="RunInstallScript"
      Directory="INSTALLDIR"
      Execute="deferred"
      Impersonate="no"
      ExeCommand='powershell.exe -ExecutionPolicy Bypass -File "[INSTALLDIR]install.ps1"' />

    <CustomAction
      Id="RunUninstallScript"
      Directory="INSTALLDIR"
      Execute="deferred"
      Impersonate="no"
      ExeCommand='powershell.exe -ExecutionPolicy Bypass -File "[INSTALLDIR]uninstall.ps1"' />

    <InstallExecuteSequence>
      <Custom Action="RunInstallScript" After="InstallFiles">NOT Installed</Custom>
      <Custom Action="RunUninstallScript" Before="RemoveFiles">REMOVE="ALL"</Custom>
    </InstallExecuteSequence>

  </Product>

</Wix>